<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blob Storage &amp; Web Service Architectuur :: Programmeren Gevorderd 3 (BETA)</title>
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Programmeren Gevorderd 3 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pg3" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Gevorderd 3</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hoofdstukken üóíÔ∏è</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-cloud-connected.html">Cloud Connected</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-microservices.html">Microservices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-az-devops.html">Iteratief Ontwikkelen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Cosmos</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Blob Storage</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Middleware</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Open Data &amp; Docker</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Secret Management</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Testing</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Authenticatie</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Autorisatie</span>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Afronden</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="80-lesopnames-2526S2.html">Lesopnames üì∫</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="00-geen-toegang.html">Geen Azure Toegang üò±</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-git.html">Git Gebruik ü•≤</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-tips.html">Extra Referenties üßê</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gevorderd 3</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Gevorderd 3</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gevorderd 3</a></li>
    <li><a href="07-blob.html">Blob Storage &amp; Web Service Architectuur</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Blob Storage &amp; Web Service Architectuur</h1>
<div class="sect1">
<h2 id="_doel_van_deze_les"><a class="anchor" href="#_doel_van_deze_les"></a>Doel van deze les</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Azure Blob Storage leren kennen.</p>
</li>
<li>
<p>Nadenken over web service architectuur.</p>
</li>
<li>
<p>Minimal Api beter leren kennen.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_story_label_maken"><a class="anchor" href="#_story_label_maken"></a>Story - Label Maken</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>AS A</strong> ShipIt Customer <strong>I WANT</strong> to print a label <strong>SO THAT</strong> I can drop off my package at a service point.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functionele_input"><a class="anchor" href="#_functionele_input"></a>Functionele Input</h3>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Klant moet een label kunnen maken op basis van</p>
<div class="ulist">
<ul>
<li>
<p>Een nieuwe of bestaande Quote</p>
</li>
<li>
<p>Adres ontvanger</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tracking</strong> is momenteel <strong>out of scope.</strong></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_technische_input"><a class="anchor" href="#_technische_input"></a>Technische Input</h3>
<div class="sidebarblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Maak een domeinlaag om het label te genereren. We willen deze logica immers ook gebruiken in de desktop applicatie van het sorteercentrum.</p>
</li>
<li>
<p>De business spreekt van een bestaande of nieuwe quote. Wanneer de klant niet vertrekt van een bestaande quote, zal de front end deze klant eerst door het quoting mechanisme loodsen. Technisch vertrekken we voor het maken van een label dus altijd van een bestaande quote.</p>
</li>
<li>
<p>Haal de details van een quote op via de quote api. Gebruik een <a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/http/httpclient">HttpClient</a>.</p>
</li>
<li>
<p>Maak een pdf label. Gebruik <a href="https://github.com/QuestPDF/QuestPDF">QuestPDF</a>.</p>
<div class="ulist">
<ul>
<li>
<p>Adres ontvanger.</p>
</li>
<li>
<p>Prijs.</p>
</li>
<li>
<p>Geen email adressen!</p>
</li>
<li>
<p>Unieke trackingcode.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Sla het label op in <a href="https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction">Azure Blob Storage</a>.</p>
</li>
<li>
<p>Voorzie een web api</p>
<div class="ulist">
<ul>
<li>
<p>POST met CreatedAtAction response.</p>
</li>
<li>
<p>GET met <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept">Accept Header</a></p>
<div class="ulist">
<ul>
<li>
<p>als json - voorzien voor later</p>
</li>
<li>
<p>als pdf file - application/octet-stream</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>De situatie die we willen bekomen bij afronding van deze story ziet eruit als volgt.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/design.png" alt="design">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_storage_account"><a class="anchor" href="#_storage_account"></a>Storage Account</h3>
<div class="paragraph">
<p>Navigeer naar de Azure Portal om de <em>Storage Account Services</em> (Opslagaccounts)weer te geven.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/storage.png" alt="storage">
</div>
</div>
<div class="paragraph">
<p>Voeg een nieuwe storage account toe.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/add.png" alt="add">
</div>
</div>
<div class="paragraph">
<p>We hebben minder vrijheid in de naamgeving dan bij de vorige resources. Kies iets logisch. Maak je resource in Europa en kies voor goedkope backups.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/review.png" alt="review">
</div>
</div>
<div class="paragraph">
<p>Je kan dan rechtstreeks naar <em>Review</em> en <em>Create</em> gaan.</p>
</div>
<div class="paragraph">
<p>Eenmaal je resource beschikbaar is op Azure, navigeer je erin naar de sectie <em>Containers</em>. Maak een nieuwe <em>Container</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/container.png" alt="container">
</div>
</div>
<div class="paragraph">
<p>De connection string die onze eigen applicatie nodig heeft, kunnen we ophalen onder de <em>Access Keys</em> sectie.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/keys.png" alt="keys">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_storage_explorer"><a class="anchor" href="#_storage_explorer"></a>Storage Explorer</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
De storage explorer functionaliteit in de Azure Portal wordt steeds beter. Voor basisoperaties, zoals de files oplijsten, wissen en downloaden, heb je de desktop applicatie niet nodig.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start de <em>Azure Storage Explorer</em> op en log in met je Hogent account.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/aselogin.png" alt="aselogin">
</div>
</div>
<div class="paragraph">
<p>De applicatie is nu verbonden met je Azure resources. Open de Explorer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/aseloggedin.png" alt="aseloggedin">
</div>
</div>
<div class="paragraph">
<p>De container die we aangemaakt hebben in de Azure Portal kan nu doorbladerd worden. Op dit moment zit er natuurlijk nog geen data in.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/asecontainer.png" alt="asecontainer">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementatie"><a class="anchor" href="#_implementatie"></a>Implementatie</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_solution"><a class="anchor" href="#_solution"></a>Solution</h3>
<div class="paragraph">
<p>We voegen een aantal nieuwe projecten toe aan de solution om de label functionaliteiten in onder te brengen. Zoals vermeld in de story, maken we deze keer een (compacte) domeinlaag. We willen de logica immers later hergebruiken in een niet-webapi project.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blob/solution.png" alt="solution">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shipit_label_persistence"><a class="anchor" href="#_shipit_label_persistence"></a>ShipIt.Label.Persistence</h3>
<div class="paragraph">
<p>Hier gaan we verbinding maken de nieuwe <em>Azure Blob Storage Account</em> om de pdf-bestanden weg te schrijven en in te lezen. We hebben nuget <code>Azure.Storage.Blobs</code> nodig.</p>
</div>
<div class="paragraph">
<p>We voorzien een interface. We gaan de blobs (Binary Large OBjects) overdragen als een array van bytes.</p>
</div>
<div class="listingblock">
<div class="title">ILabelRepository.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public interface ILabelRepository
{
    Task WriteAsync(byte[] content, string trackingNumber);
    Task&lt;byte[]&gt; ReadAsync(string trackingNumber);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>De basics om een <em>handle</em> op een blob file te krijgen, zijn dezelfde bij lezen of schrijven.</p>
</div>
<div class="listingblock">
<div class="title">LabelRepository.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">private BlobClient GetBlobClient(string fileName)
{
    var client = new BlobServiceClient(_options.ConnectionString); <i class="conum" data-value="1"></i><b>(1)</b>
    var containerClient = client.GetBlobContainerClient(_options.Container); <i class="conum" data-value="2"></i><b>(2)</b>
    return containerClient.GetBlobClient(fileName); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verbinding maken met storage account. De connectionstring komt via <em>Options Pattern</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Verbinding maken met de container die we voorzien hebben voor de labels.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>De specifieke blob file benaderen waarin we willen lezen of schrijven.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Om files uit te lezen, gebruik je de <em>Download</em> methodes op de <em>BlobClient</em>. Om files te (over)schrijven, gebruik je de <em>Upload</em> methodes.</p>
</div>
<div class="listingblock">
<div class="title">LabelRepository.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public async Task&lt;byte[]&gt; ReadAsync(string trackingNumber)
{
    var blob = GetBlobClient($"{trackingNumber}.pdf"); <i class="conum" data-value="1"></i><b>(1)</b>
    var download = await blob.DownloadContentAsync();
    return download.Value.Content.ToArray();
}

public async  Task WriteAsync(byte[] content, string trackingNumber)
{
    var blob = GetBlobClient($"{trackingNumber}.pdf"); <i class="conum" data-value="1"></i><b>(1)</b>
    await blob.UploadAsync(new BinaryData(content));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Onze eigen methode die een blob handle teruggeeft.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_shipit_label_domain_dto"><a class="anchor" href="#_shipit_label_domain_dto"></a>ShipIt.Label.Domain(.DTO)</h3>
<div class="paragraph">
<p>We voorzien domeinklassen. We hebben uiteraard een <code>Label</code> nodig. Het lijkt ook nuttig om een <code>Adress</code> klasse te voorzien. Deze klassen behoren toe aan het domein en mogen niet door de api of ui gebruikt worden. We voegen dus ook een <code>DomainController</code> en een <code>DTO</code> toe om het geheel mooi te scheiden.</p>
</div>
<div class="sect3">
<h4 id="_interactie_met_bovenliggende_lagen"><a class="anchor" href="#_interactie_met_bovenliggende_lagen"></a>Interactie met bovenliggende lagen</h4>
<div class="listingblock">
<div class="title">ShipIt.Label.Domain.DTO/LabelCreation.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class LabelCreation
{
    public string RecipientName { get; set; }
    public string RecipientAddressLine1 { get; set; }
    public string RecipientAddressLine2 { get; set; }
    public string RecipientCountry { get; set; }
    public double ShipmentPrice { get; set; }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">IDomainController.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public interface IDomainController
{
    Task&lt;string&gt; CreateLabelAsync(LabelCreation labelCreation);

    Task&lt;byte[]&gt; GetLabelAsync(string trackingNumber);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_intern_domein"><a class="anchor" href="#_intern_domein"></a>Intern Domein</h4>
<div class="paragraph">
<p>De interne klassen van het domein zijn rijker.</p>
</div>
<div class="listingblock">
<div class="title">Address.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">internal class Address
{
    public string Name { get; set; }
    public string AddressLine1 { get; set; }
    public string AddressLine2 { get; set; }
    public string Country { get; set; }

    public Address(){

    }

    public Address(LabelCreation labelCreation)
    {
        Name = labelCreation.RecipientName;
        AddressLine1 = labelCreation.RecipientAddressLine1;
        AddressLine2 = labelCreation.RecipientAddressLine2;
        Country = labelCreation.RecipientCountry;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We weten dat het label een pdf representatie nodig heeft. QuestPDF voorziet een <em>IDocument</em> interface. Door deze te implementeren kunnen we gemakkelijk ons model als pdf weergeven. Door dit te doen, hebben we impliciet gekozen voor een "rijk" model, dwz er zit logica/gedrag in.</p>
</div>
<div class="listingblock">
<div class="title">Label.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;

namespace ShipIt.Label.Domain;

internal class Label : IDocument
{
    public Address Address { get; set; }
    public string TrackingNumber { get; set; }
    public double Price { get; set; }

    public Label(Address address, double price)
    {
        Address = address;
        Price = price;
        TrackingNumber = Guid.NewGuid().ToString();
    }

    public void Compose(IDocumentContainer container)
    {
        container.Page(page =&gt;
		{
			page.Size(PageSizes.A4);
			page.Margin(4.0f, Unit.Centimetre);


			page.Header()
				.Text($"ShipIt Label {TrackingNumber}")
				.FontSize(28)
				.Bold()
				.FontColor(Colors.Red.Darken2);

			page.Content()
				.PaddingVertical(8)
				.Column(column =&gt;
				{
 					column.Item().Text(Address.Name);
                    column.Item().Text(Address.AddressLine1);
                    column.Item().Text(Address.AddressLine2);
                    column.Item().Text(Address.Country);
                    column.Item().Text(Price.ToString());
				});

			page.Footer()
				.AlignCenter()
				.Text("De kleine lettertjes");
		});
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>De QuestPDF nuget zal er ook voor zorgen dat de methode <em>GeneratePdf()</em> beschikbaar wordt op instanties van onze klasse die <em>IDocument</em> implementeert.</p>
</div>
<div class="listingblock">
<div class="title">DomainController</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class DomainController(ILabelRepository repo) : IDomainController <i class="conum" data-value="1"></i><b>(1)</b>
{
    private readonly ILabelRepository _repo = repo;

    public async Task&lt;string&gt; CreateLabelAsync(LabelCreation labelCreation) <i class="conum" data-value="2"></i><b>(2)</b>
    {
        var label = new Label(
            new Address(labelCreation), labelCreation.ShipmentPrice); <i class="conum" data-value="3"></i><b>(3)</b>

        await _repo.WriteAsync(
            label.GeneratePdf(), label.TrackingNumber);

        return label.TrackingNumber;
    }

    public Task&lt;byte[]&gt; GetLabelAsync(string trackingNumber){
        return _repo.ReadAsync(trackingNumber);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Het repository zal via dependency injection binnenkomen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>DTO komt binnen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Op dit moment is het <code>Label</code> volwaardig, maar de pdf bestaat nog niet. Deze wordt pas aangemaakt wanneer de <code>Compose()</code> methode aangeroepen wordt door <code>GeneratePDF()</code>. Deze methode geeft de pdf terug als een eenvoudige <code>byte[]</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shipit_label_api"><a class="anchor" href="#_shipit_label_api"></a>ShipIt.Label.Api</h3>
<div class="paragraph">
<p>We willen de label functionaliteit als api blootstellen. Gezien alle logica in het domein vervat zit, gaan we geen service laag maken in het api project. We maken een <em>minimal api</em> en schrijven alle api code in <code>Program.cs</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dit kan een geldige keuze in bepaalde scenario&#8217;s en is niet per definitie "beter" of "slechter" dan een api met api controllers. Hier doen we dit vooral om het eens gedaan te hebben ‚úÖ
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We voorzien een basic contract om het Request voor te stellen.</p>
</div>
<div class="listingblock">
<div class="title">LabelRequestContract</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public record LabelRequestContract
{
    public string QuoteId { get; set; } <i class="conum" data-value="1"></i><b>(1)</b>
    public string RecipientName { get; set; }
    public string RecipientAddressLine1 { get; set; }
    public string RecipientAddressLine2 { get; set; }
    public string RecipientCountry { get; set; }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We krijgen een referentie naar een Quote mee. We gaan aan de hand daarvan zelf de prijs opzoeken. We geven de gebruiker de kans niet om de prijs zelf mee te geven in deze request klasse - ze zouden immers durven liegen!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>D api zal een call moeten doen naar de Quote api om de prijs op te halen. Om http calls te doen vanuit onze eigen code, gebruiken we <code>HttpClient</code>. Er zijn vele manieren om clients te instanti√´ren en te gebruiken, dit is maar een van die manieren.</p>
</div>
<div class="listingblock">
<div class="title">Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var builder = WebApplication.CreateBuilder(args);

builder.Services.Configure&lt;LabelRepositoryOptions&gt;(
    builder.Configuration.GetSection(
        nameof(LabelRepositoryOptions)));

builder.Services.AddHttpClient(); <i class="conum" data-value="1"></i><b>(1)</b>
builder.Services.AddProblemDetails();
builder.Services.AddScoped&lt;ILabelRepository, LabelRepository&gt;(); <i class="conum" data-value="2"></i><b>(2)</b>
builder.Services.AddScoped&lt;IDomainController, DomainController&gt;(); <i class="conum" data-value="3"></i><b>(3)</b>

QuestPDF.Settings.License = QuestPDF.Infrastructure.LicenseType.Community; <i class="conum" data-value="4"></i><b>(4)</b>

var app = builder.Build();

app.MapPost("api/labels", async Task&lt;CreatedAtRoute&lt;string&gt;&gt; (
    IHttpClientFactory clientFactory,
    [FromBody] LabelRequestContract contract,
    IDomainController domain) =&gt; {

    // get price

    // create label

    // return trackingNumber / resource identifier

});

app.MapGet("api/labels/{trackingnumber}",
async Task&lt;Results&lt;Ok&lt;string&gt;, BadRequest, FileContentHttpResult&gt;&gt;(
    [FromRoute] string trackingNumber,
    [FromHeader(Name = "Accept")] string acceptValue,
    IDomainController domain) =&gt;
{
    // TODO
}).WithName("GetLabel"); <i class="conum" data-value="5"></i><b>(5)</b>

app.Run();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We registreren httpclient bij de DI container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We registreren het repository bij de DI container.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We registreren de domeincontroller bij de DI container.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We registreren het QuestPDF licentie type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We benoemen de Get expliciet zodat we er elders kunnen naar verwijzen.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Laat ons de <code>Post()</code> van dichterbij bekijken</p>
</div>
<div class="listingblock">
<div class="title">Program.cd/Post()</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">app.MapPost("api/labels", async Task&lt;CreatedAtRoute&lt;string&gt;&gt; (
    IHttpClientFactory clientFactory, <i class="conum" data-value="1"></i><b>(1)</b>
    [FromBody] LabelRequestContract contract, <i class="conum" data-value="2"></i><b>(2)</b>
    IDomainController domain) =&gt; {

    // get price
    var httpClient = clientFactory.CreateClient();
    var baseUrl = builder.Configuration.GetValue&lt;string&gt;("QuoteApiBaseUrl");
    var url = $"{baseUrl}/api/pricequotes/{contract.QuoteId}";

    var options = new JsonSerializerOptions();
    options.Converters.Add(new JsonStringEnumConverter());
    options.PropertyNameCaseInsensitive = true;
    var response = await httpClient
        .GetFromJsonAsync&lt;PriceQuoteResponseContract&gt;(url, options); <i class="conum" data-value="3"></i><b>(3)</b>

    // create label
    var creation = new LabelCreation{
        RecipientAddressLine1 = contract.RecipientAddressLine1,
        RecipientAddressLine2 = contract.RecipientAddressLine2,
        RecipientCountry = contract.RecipientCountry,
        RecipientName = contract.RecipientName,
        ShipmentPrice = response.Price <i class="conum" data-value="4"></i><b>(4)</b>
    };
    var trackingNumber = await domain.CreateLabelAsync(creation); <i class="conum" data-value="4"></i><b>(4)</b>

    // return trackingNumber / resource identifier
    return TypedResults.CreatedAtRoute( <i class="conum" data-value="5"></i><b>(5)</b>
        trackingNumber, "GetLabel", new { trackingnumber = trackingNumber});
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We verkrijgen een HttpClientFactory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Het labelrequest komt uit de Request Body.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We gebruiken de client om een http call te doen naar de Quote api. De response wordt in dezelfde beweging gemapped op een object van het type QuoteResponseDTO. Deze url moet uiteraard komen uit configuratie via het Options Pattern.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nu we de prijs kennen, vragen we het domein een label te maken. We krijgen het trackingnumber terug.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We geven een resultaat terug dat de locatie van de aangemaakte resource bevat alsook een response object met het trackingnumber.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Laat ons de <code>Get()</code> van dichterbij bekijken. De story vertelt ons dat de partij die onze api oproept via een <code>Accept</code> header kan meegeven welke representatie deze van het label wil: json of pdf.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Het kan handig zijn een resource in meerdere representaties beschikbaar te hebben. Denk bijvoorbeeld aan een <code>svg</code> bestand - je zou dit kunnen opvragen als <code>xml</code> of als <code>png</code> resource. Hier doen we dit vooral om het eens gedaan te hebben ‚úÖ
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Program.cs/Get()</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">app.MapGet("api/labels/{trackingnumber}",
async Task&lt;Results&lt;Ok&lt;string&gt;, BadRequest, FileContentHttpResult&gt;&gt;( <i class="conum" data-value="1"></i><b>(1)</b>
    [FromRoute] string trackingNumber, <i class="conum" data-value="2"></i><b>(2)</b>
    [FromHeader(Name = "Accept")] string acceptValue, <i class="conum" data-value="3"></i><b>(3)</b>
    IDomainController domain) =&gt;
{
    if(acceptValue == "text/json") <i class="conum" data-value="4"></i><b>(4)</b>
    {
        // Dummy implementatie
        return TypedResults.Ok(trackingNumber);
    }
    else if (acceptValue == "application/octet-stream") <i class="conum" data-value="5"></i><b>(5)</b>
    {
        var pdfStream = await domain.GetLabelAsync(trackingNumber);
        return TypedResults.Bytes(
            pdfStream,
            "application/octet-stream",
            $"{trackingNumber}.pdf");
    }

    return TypedResults.BadRequest(); <i class="conum" data-value="6"></i><b>(6)</b>

}).WithName("GetLabel");</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>De verschillende return types worden opgelijst.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Deze input wordt uit de route gelezen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Deze input wordt uit een header gelezen.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>De client vraagt json.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>De client vraagt pdf, we voeren dat uit. We geven een filename mee. Dit staat los van de filename op blob storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>De inhoud van de Accept header is niet ondersteund door dit endpoint.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_solution_runnen"><a class="anchor" href="#_solution_runnen"></a>Solution Runnen</h3>
<div class="paragraph">
<p>Let op: De nieuwe label api zal de bestaande quote api uit dezelfde solution aanroepen. Dit wil zeggen dat je twee startup items nodig hebt.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In VS Code hoef je geen speciale runsettings aan te maken. Je kan gewoon een tweede (en derde etc.) project opstarten.</p>
</li>
<li>
<p>In Visual Studio maak je de instellingen <a href="https://learn.microsoft.com/en-us/visualstudio/ide/how-to-set-multiple-startup-projects?view=vs-2022">zo</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_deployen"><a class="anchor" href="#_deployen"></a>Deployen</h3>
<div class="paragraph">
<p>We hebben nu twee services om te deployen.</p>
</div>
<div class="literalblock">
<div class="title">Quote</div>
<div class="content">
<pre>az webapp up `
  --name pg3-shipit-stefanc-quote-api `
  --plan pg3-shipit-stefanc-plan `
  --resource-group pg3-shipit-stefanc `
  --location westeurope `
  --os-type Linux</pre>
</div>
</div>
<div class="literalblock">
<div class="title">Label</div>
<div class="content">
<pre>az webapp up `
  --name pg3-shipit-stefanc-label-api `
  --plan pg3-shipit-stefanc-plan `
  --resource-group pg3-shipit-stefanc `
  --location westeurope `
  --os-type linux</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Linux targets vereisen eventueel extra dependencies voor QuestPDF. Indien de Azure deployment erover klaagt in de logs, voegen we deze toe.<br>
<br>
<code>HarfBuzzSharp.NativeAssets.Linux</code><br>
<code>SkiaSharp.NativeAssets.Linux.NoDependencies</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/blob/deploy.png" alt="deploy"></span></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Je kan de pdf in dit geval niet downloaden met een gewone web browser omdat de gepaste Accept header niet gezet wordt. Dit resulteert in een BadRequest.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oefening"><a class="anchor" href="#_oefening"></a>Oefening</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Probeer zelf de taken van deze week te implementeren. Je kan steeds kijken naar de code uit de les als je vast loopt.</p>
</li>
<li>
<p>Probeer zelf een herimplementatie van de quote api te maken waar alles gebeurt in √©√©n laag in √©√©n minimal api file.</p>
<div class="ulist">
<ul>
<li>
<p>Beschouw de http endpoints als "handlers" die verantwoordelijk zijn voor alles wat binnen de scope van een api call moet gebeuren. Geen lagen, geen abstracties, enkel strikt noodzakelijke mapping. <em>Straight to the point.</em></p>
</li>
<li>
<p>Je zal eindigen met drastisch minder lijnen code (en een piepkleine solution) voor het quote gedeelte. Het is een totaal andere aanpak. Beter? Slechter? Hangt ervan af üòä</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_referenties"><a class="anchor" href="#_referenties"></a>Referenties</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/http/httpclient">HttpClient</a></p>
</div>
<div class="paragraph">
<p><a href="https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction">Azure Blob Storage</a></p>
</div>
<div class="paragraph">
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept">Accept Header</a></p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <p>This page was built using a customized version of the Antora default UI. The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Course material may *not* be used to teach, tutor, coach, or present without obtaining explicit consent from Stefan Courteaux.</p>
</footer><script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
