<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Autorisatie AJ 2526 :: Programmeren Gevorderd 3 (BETA)</title>
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Programmeren Gevorderd 3 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pg3" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Gevorderd 3</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">ShipIt App üì¶Ô∏è</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-cloud-connected.html">Cloud Connected</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-microservices.html">Microservices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-az-devops.html">Iteratief Ontwikkelen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-cosmos.html">Cosmos &amp; Options Pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-blob.html">Blob Storage &amp; PDF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-middleware.html">Middleware &amp; Extensions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-open-data-2526.html">Open Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-auth-2526.html">Authenticatie</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="09-auth-2526-2.html">Autorisatie</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-technisch.html">Technische Lessen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-docker-2526.html">Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-02-secret-management.html">Secret Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-testing-2526.html">Testing Pyramid</a>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">CI/CD</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="80-lesopnames-2526S2.html">Lesopnames üì∫</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="00-geen-toegang.html">Geen Azure Toegang üò±</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-git.html">Git Gebruik ü•≤</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-tips.html">Extra Referenties üßê</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gevorderd 3</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Gevorderd 3</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gevorderd 3</a></li>
    <li>ShipIt App üì¶Ô∏è</li>
    <li><a href="09-auth-2526-2.html">Autorisatie</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Autorisatie AJ 2526</h1>
<div class="sect1">
<h2 id="_doel_van_deze_les"><a class="anchor" href="#_doel_van_deze_les"></a>Doel van deze les</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Autorisatie van App Clients</p>
</li>
<li>
<p>Koppeling met React front-end</p>
<div class="ulist">
<ul>
<li>
<p>Inloggen/Uitloggen als User</p>
</li>
<li>
<p>Data uitlezen</p>
</li>
</ul>
</div>
</li>
<li>
<p>User roles</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_app_clients"><a class="anchor" href="#_app_clients"></a>App Clients</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_postman"><a class="anchor" href="#_postman"></a>Postman</h3>
<div class="paragraph">
<p>Op dit moment controleren we in de voorbeeldcode of een client systeem een geldige identiteit heeft (authenticatie). De volgende stap is het conditioneel toestaan (autoriseren) van api operaties op basis van "rechten". Hiervoor worden <code>scopes</code> gebruikt.</p>
</div>
<div class="paragraph">
<p>We registreren deze in Identity Server. We hebben totale vrijheid om de namen te bepalen en operaties in het systeem te associ√´ren.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public static class Config {
    //...
    public static IEnumerable&lt;ApiScope&gt; ApiScopes =&gt;
        new ApiScope[] {
            new ApiScope("shipit.pricequotes.api.read"), <i class="conum" data-value="1"></i><b>(1)</b>
            new ApiScope("shipit.pricequotes.api.write"), <i class="conum" data-value="1"></i><b>(1)</b>
        };

    public static IEnumerable&lt;Client&gt; Clients =&gt;
        new Client[] {
            new Client{ ClientId = "postman-client",
                //...
                AllowedScopes = { "shipit.pricequotes.api.read" } <i class="conum" data-value="2"></i><b>(2)</b>
            }
        };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We defini√´ren twee scopes: een om te lezen en een om te schrijven.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Op dit moment wordt enkel de scope om te lezen geassocieerd.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Je kan de <code>Config.cs</code> inhoud steeds naar de database syncen door IS op te starten met <code>/seed</code> argument.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nu we precieze scopes gedefinieerd hebben, kunnen we deze aanwenden in de PriceQuote api. De oneliner <code>builder.Services.AddAuthorization()</code> in <code>ShipIt.PriceQuote.Api/Program.cs</code> wordt vervangen door een rijkere definitie onder de vorm van <em>Policies</em>.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">//...
builder.Services.AddAuthorizationBuilder()
    .AddPolicy("QuoteReadPolicy", policy =&gt;
        {
            policy.RequireAuthenticatedUser();
            policy.RequireClaim("scope",
                "shipit.pricequotes.api.read");
        })
    .AddPolicy("QuoteWritePolicy", policy =&gt;
        {
            policy.RequireAuthenticatedUser();
            policy.RequireClaim("scope",
                "shipit.pricequotes.api.write");
        });
//...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We associ√´ren deze policies aan de relevante api endpoints.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Controllers/PriceQuoteController.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">[Route("api/pricequotes")]
[Authorize]
[ApiController]
public class PriceQuoteController(
    IPriceQuoteService priceQuoteService): ControllerBase
{
    [HttpPost]
    [EnableRateLimiting("quote-creation-limiter")]
    [Authorize(Policy = "QuoteWritePolicy")] <i class="conum" data-value="1"></i><b>(1)</b>
    public ... CreatePriceQuoteAsync(...)
    {
        //...
    }

    [HttpGet("{id}")]
    [Authorize(Policy = "QuoteReadPolicy")] <i class="conum" data-value="2"></i><b>(2)</b>
    public ... GetPriceQuoteAsync(...)
    {
        //...
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CreatePriceQuoteAsync</code> aanroepen checkt <code>QuoteWritePolicy</code> af</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>GetPriceQuoteAsync</code> aanroepen checkt <code>QuoteReadPolicy</code> af</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start IS en de Quote Api op. Vraag een token aan met Postman.</p>
</div>
<div class="listingblock">
<div class="title">Token</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "access_token": "blabalabalaLkQtAKDXVxQ",
    "expires_in": 3600,
    "token_type": "Bearer",
    "scope": "shipit.pricequotes.api.read"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>De <code>GET</code> operatie geassocieerd aan scope <code>shipit.pricequotes.api.read</code> zal slagen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-quick/postman-scope-200.png" alt="postman scope 200">
</div>
</div>
<div class="paragraph">
<p>De <code>POST</code> operatie geassocieerd aan scope <code>shipit.pricequotes.api.write</code> zal falen. De Postman client heeft geen toegang tot de scope, en het token bevat deze dus niet. We ontvangen een 403, dwz "ik ken je wel, maar jij mag dit niet doen".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-quick/postman-scope-403.png" alt="postman scope 403">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Er bestaan geen harde regels over hoe je scopes moet opbouwen. Je bepaalt zelf het niveau van detail, de naamgeving en de associatie aan api endpoints.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Probeer duidelijk te zijn en denk steeds goed na over welke clients welke rechten nodig hebben.</p>
</li>
<li>
<p>Wanneer we alle operaties vanuit Postman willen testen, heeft deze client uiteraard meer rechten nodig.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_labelapi"><a class="anchor" href="#_labelapi"></a>LabelApi</h3>
<div class="paragraph">
<p>Op dit moment zal de Label Api er niet langer in slagen de Quote Api aan te roepen. De Label Api heeft geen <em>Client Credentials</em> en vraagt geen token aan bij Identity Server. Bijgevolg zal de Quote Api de calls weigeren met http status code <code>401</code> "Ik ken jou niet."</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-quick/label-api-fail.png" alt="label api fail">
</div>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">//...
public static IEnumerable&lt;Client&gt; Clients =&gt;
    new Client[]
    {
        // systeem naar systeem client voor postman
        //...
        // systeem naar systeem client voor label api
        new Client{ <i class="conum" data-value="1"></i><b>(1)</b>
            ClientId = "label-api-client",
            AllowedGrantTypes = GrantTypes.ClientCredentials,
            ClientSecrets = {new Secret("eenLabelGeheim".Sha256())},
            AllowedScopes = { "shipit.pricequotes.api.read" } <i class="conum" data-value="2"></i><b>(2)</b>
        }
    };
//...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Client credentials voor Label Api</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>De Label Api moet enkel pricequotes kunnen lezen, <strong>niet</strong> maken.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Voeg <code>Duende.IdentityModel</code> toe aan <code>ShipIt.Label.Api</code>. Dit voorziet handige extension methods om met Identity Server te interageren vanuit <code>C#</code>. Dankzij deze abstractie, hoef je de IS http api niet echt te kennen.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.Label.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">app.MapPost("api/labels", ... (...) =&gt; {
    // TODO move settings to config!
    var client = clientFactory.CreateClient();
    var isUrl = "https://localhost:5001";
    var disco = await client.GetDiscoveryDocumentAsync(isUrl); <i class="conum" data-value="1"></i><b>(1)</b>
    var tokenResponse = await client
        .RequestClientCredentialsTokenAsync( <i class="conum" data-value="2"></i><b>(2)</b>
            new ClientCredentialsTokenRequest {
                Address = disco.TokenEndpoint,
                ClientId = "label-api-client",
                ClientSecret = "eenLabelGeheim",
                Scope = "shipit.pricequotes.api.read"
            });
    // ...
    client.SetBearerToken(tokenResponse.AccessToken); <i class="conum" data-value="3"></i><b>(3)</b>
    var priceQuote = await client
        .GetFromJsonAsync&lt;PriceQuoteResponseContract&gt;(
            url,jsonOptions);
    client.SetBearerToken(string.Empty); <i class="conum" data-value="4"></i><b>(4)</b>
    // ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Leest IS discovery document uit om api endpoints te kennen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Token aanvragen met Client Credentials.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Token op httpClient zetten, pricequote api call maken.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In ons voorbeeld wordt de httpClient herbruikt om de FR api aan te roepen. We willen niet per ongeluk een token lekken naar hun servers, dus we maken het veld leeg.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De Label Api zal nu terug werken wanneer we deze vanuit Postman aanroepen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-quick/label-api-ok.png" alt="label api ok">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
De Label Api respecteert nu de beveiliging van de Quote Api, maar dwingt zelf (nog) geen security af voor zijn eigen callers! Om dat te doen, moeten we ook voor de Label operatie scopes cre√´ren en deze afdwingen met policies.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ui_integratie"><a class="anchor" href="#_ui_integratie"></a>UI Integratie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We voorzien een piepkleine React app met volgende functionaliteit</p>
</div>
<div class="ulist">
<ul>
<li>
<p>inloggen en uitloggen via OIDC protocol (Identity Server)</p>
</li>
<li>
<p>pricequote opzoeken op basis van bestaand Id</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="content">
<video src="_images/identity-server-quick/is-react-shipit-h265.mp4" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="sect2">
<h3 id="_flow"><a class="anchor" href="#_flow"></a>Flow</h3>
<div class="paragraph">
<p>Om het inloggen te voorzien, zal de React app moeten interageren met Identity Server. Onze app zal de gebruiker redirecten naar de login pagina van Identity Server. Wanneer de login slaagt, zal Identity Server op zijn beurt de gebruiker redirecten naar de app.</p>
</div>
<div class="paragraph">
<p>Je kan deze interactie volledig artisanaal implementeren, maar het is uiteraard interessanter te steunen op het reeds gedane werk van anderen.</p>
</div>
<div class="paragraph">
<p>Er bestaat een volwaardige typescript OIDC-client implementatie: <a href="https://github.com/authts/oidc-client-ts">oidc-client-ts</a>.</p>
</div>
<div class="paragraph">
<p>En voor die client bestaat een <em>React Provider</em>: <a href="https://github.com/authts/react-oidc-context">react-oidc-context</a>. üë®‚Äçüç≥üòò</p>
</div>
<div class="paragraph">
<p>Zoals eerder vermeld, is dit niet specifiek aan Identity Server. Identity Server is <em>gewoon</em> een Identity Provider die de nodige protocols implementeert.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ui_client"><a class="anchor" href="#_ui_client"></a>UI Client</h3>
<div class="paragraph">
<p>De web app heeft zijn eigen App Client nodig. Deze is uitgebreider dan een backend client omdat Identity Server moet weten naar waar te redirecten bij in- en uitloggen.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">// ...
new Client {
    ClientId = "webapp-client",
    ClientSecrets = {new Secret("webapp-secret".Sha256())},
    AllowedGrantTypes = GrantTypes.Code,
    AllowedScopes = {
        IdentityServerConstants.StandardScopes.OpenId,
        IdentityServerConstants.StandardScopes.Profile,
        "shipit.pricequotes.api.read"
    },
    RedirectUris = { "http://localhost:5173/" }, <i class="conum" data-value="1"></i><b>(1)</b>
    PostLogoutRedirectUris = { "http://localhost:5173/" }, <i class="conum" data-value="2"></i><b>(2)</b>
    AllowedCorsOrigins = ["http://localhost:5173"], <i class="conum" data-value="3"></i><b>(3)</b>
}
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Login callback url</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Logout callback url</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>CORS. Opgelet: geen trailing <code>/</code> (origin vs url)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_react_project"><a class="anchor" href="#_react_project"></a>React Project</h3>
<div class="paragraph">
<p>Het voorbeeldproject is <a href="https://dev.azure.com/hogent-web4-stefancourteaux/ShipIt2526S1/_git/ShipItReact2526S1">online beschikbaar</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dit is een technische demonstratie van de nodige dependencies en interactie. React "best practices" leer je - uiteraard - in Web 3 üë©‚Äçüíª
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_inloggen_uitloggen"><a class="anchor" href="#_inloggen_uitloggen"></a>Inloggen &amp; Uitloggen</h3>
<div class="paragraph">
<p>Eerst activeren we de <code>react-oidc-context</code> in de app.</p>
</div>
<div class="listingblock">
<div class="title">main.tsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// ... andere imports
import { AuthProvider } from "react-oidc-context"; <i class="conum" data-value="1"></i><b>(1)</b>
import type { UserManagerSettings } from "oidc-client-ts"; <i class="conum" data-value="1"></i><b>(1)</b>

const settings: UserManagerSettings = { <i class="conum" data-value="2"></i><b>(2)</b>
  authority: "https://localhost:5001",
  client_id: "webapp-client",
  client_secret: "webapp-secret",
  redirect_uri: "http://localhost:5173/",
  response_type: "code",
  scope: "openid profile shipit.pricequotes.api.read",
  monitorSession: true,
};

const onSigninCallback = (): void =&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
  window.history.replaceState({},
  document.title,
  window.location.pathname);
};

createRoot(document.getElementById("root")!).render(
  &lt;StrictMode&gt;
    &lt;AuthProvider {...settings} <i class="conum" data-value="4"></i><b>(4)</b>
        onSigninCallback={onSigninCallback}&gt;
      &lt;App /&gt;
    &lt;/AuthProvider&gt;
  &lt;/StrictMode&gt;
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import van de gebruikte libs om met IS te communiceren.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>UI App Client configuratie</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Wanneer IS de gebruiker terugbrengt naar onze app, zal er achteraan de url authenticate <em>foefelare</em> hangen. Gooi dit weg zodat de gebruiker het niet ziet en we, naargelang implementatie, niet in een login loop belanden.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Wrap je app in de <code>AuthProvider</code> zodat je overal op de relevante context kan inhaken via de <code>useAuth()</code> hook.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dan koppelen we de login functionaliteit aan een knop. In het voorbeeld gebeurt dit in de header.</p>
</div>
<div class="listingblock">
<div class="title">header.tsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { useAuth } from "react-oidc-context";

export const Header = () =&gt; {

  const { isAuthenticated, signinRedirect,
          signoutRedirect, user } = useAuth(); <i class="conum" data-value="1"></i><b>(1)</b>

  return (
    &lt;div className="h-24 p-4 bg-gray-200 font-bold shadow-md"&gt;
      &lt;div&gt;
        &lt;p className="float-left p-2 m-2 text-2xl"&gt;
            Glorious ShipIt App
        &lt;/p&gt;
      &lt;/div&gt;
      &lt;button
        className={
          "float-left p-2 my-3 border-1 border-indigo-600 " +
          "hover:bg-indigo-600 text-indigo-600 hover:text-white " +
          (isAuthenticated ? "" : "animate-pulse")
        }
        onClick={() =&gt; ( isAuthenticated  <i class="conum" data-value="2"></i><b>(2)</b>
            ? signoutRedirect()
            : signinRedirect() )}
      &gt;
        {isAuthenticated <i class="conum" data-value="3"></i><b>(3)</b>
          ? `Logout userId ${JSON.stringify(user?.profile.sub)}`
          : "Login"}
      &lt;/button&gt;
    &lt;/div&gt;
  );
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Auth context hook aanroepen en destructen tot relevante elementen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Als de user authenticated is, zal de knop uitloggen, anders inloggen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Als de user authenticated is, wordt het user id getoond, anders niet.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_token_inhoud"><a class="anchor" href="#_token_inhoud"></a>Token Inhoud</h4>
<div class="paragraph">
<p>Op dit moment zal het token er ongeveer zo uitzien.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "iss": "https://localhost:5001",
  "nbf": 1764103779,
  "iat": 1764103779,
  "exp": 1764107379,
  "aud": "https://localhost:5001/resources",
  "scope": [
    "openid",
    "profile",
    "shipit.pricequotes.api.read"
  ],
  "amr": [
    "pwd"
  ],
  "client_id": "webapp-client",
  "sub": "38c9021f-ea63-4373-80d7-b6f971732d39",
  "auth_time": 1764103762,
  "idp": "local",
  "sid": "8591B94F024BAD729C359284A26E20EB",
  "jti": "666448D5735290C1A8D14E85F0172439"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>De <code>sub</code> claim is het UserId in de AspNetUsers tabel. Als de applicatie nood heeft aan meer informatie over de user, kan deze opgevraagd worden bij de identity provider op het <code>/connect/userinfo</code> endpoint.</p>
</div>
<div class="paragraph">
<p>We kunnen dit uitproberen door via Postman een call te maken naar het endpoint met het token dat we zonet uit de React app gevist hebben.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-quick/postman-userinfo.png" alt="postman userinfo">
</div>
</div>
<div class="paragraph">
<p>Ola! Kan dat zomaar? Tokens in het rond kopi√´ren <em>en al</em>? Ja, we hebben geen controle over wat gebeurt op de computer van de klant. Ook de CORS configuratie helpt hier niet, want dat wordt in de browser afgedwongen ü§†</p>
</div>
<div class="paragraph">
<p>Je ziet maar weer: in de praktijk moet een backend alles dubbel en dik controleren!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Men kan aannemen dat de react OIDC library ook ondersteuning biedt om het userinfo endpoint te ondervragen. Dit ligt buiten de scope van PG3.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pricequote_lezen"><a class="anchor" href="#_pricequote_lezen"></a>PriceQuote Lezen</h3>
<div class="paragraph">
<p>De PriceQuote Api heeft specifieke CORS (Cross Origin Resource Sharing) settings nodig. Anders zal de React app er niet kunnen mee samenwerken.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">// ...
builder.Services.AddCors(options =&gt;
{
    options.AddDefaultPolicy(
        policy =&gt;
        {
            policy.WithOrigins("http://localhost:5173")
            .AllowAnyHeader()
            .AllowAnyMethod();
        });
});

var app = builder.Build();
app.UseRateLimiter();

app.UseRouting(); <i class="conum" data-value="1"></i><b>(1)</b>
app.UseCors();
app.UseAuthorization();

app.MapControllers();

app.MapOpenApi();
app.MapScalarApiReference();
// ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Opgelet! De volgorde waarin deze middlewares geactiveerd worden speelt een rol.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vervolgens kunnen we in de React app een implementatie maken die het api endpoints aanroept en de data presenteert.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dit hoeft allemaal niet in dezelfde file te staan, maar wie opgelet heeft in Web 3 weet dat natuurlijk wel üòé
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pricequote.tsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// andere imports...
import Axios from "axios";

interface PriceQuoteResponse { <i class="conum" data-value="1"></i><b>(1)</b>
  id: string;
  widthCm: number;
  heightCm: number;
  // ... veldjes die je nodig hebt
}

export const PriceQuote = () =&gt; {
  const [quoteId, setQuoteId] = useState(""); <i class="conum" data-value="2"></i><b>(2)</b>
  const [priceQuote,setPriceQuote] = useState&lt;PriceQuoteResponse&gt;();
  const { user } = useAuth();

  const fetchPriceQuote = async () =&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    try {
      const response = await Axios.get(
        `https://localhost:7146/api/pricequotes/${quoteId}`,
        {
          headers: {
            Authorization: `Bearer ${user?.access_token}`, <i class="conum" data-value="4"></i><b>(4)</b>
          }
        }
      );
      console.log(JSON.stringify(response));
      setPriceQuote(response.data); <i class="conum" data-value="5"></i><b>(5)</b>
    } catch (error) {
      console.log(error);
    } finally {
        // een opportuniteit om iet intelligent te doen
    }
  };

  return (
    &lt;div className="border-0 clear-both p-6 shadow-md"&gt;
      &lt;form&gt;
        &lt;QuoteId
            quoteId={quoteId}
            setQuoteId={setQuoteId}&gt;&lt;/QuoteId&gt;
        &lt;button
          className="w-full mb-2 bg-gray-200 etc..."
          type="button"
          onClick={fetchPriceQuote} <i class="conum" data-value="6"></i><b>(6)</b>
        &gt;
          Fetch By Id
        &lt;/button&gt;
            // React om priceQuote state stuff op de UI te tonen <i class="conum" data-value="7"></i><b>(7)</b>
        &lt;/div&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  );
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Api response contractje.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>State en context hooks naar smaak.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Functie die (op basis van axios) de relevante api kan aanroepen.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Het token moet in de request. Daar draait gans het verhaal om.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Steek de api response data in state.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Associeer de knop aan de functie om de api aan te roepen.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Schrijf react code die de state rendert.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_roles"><a class="anchor" href="#_user_roles"></a>User Roles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Op dit moment mag elke ingelogde gebruiker pricequotes lezen en schrijven. Dit komt omdat we enkel de rechten van de web app afchecken. De gebruikers hebben geen specifieke rechten.</p>
</div>
<div class="sect2">
<h3 id="_aanmaken"><a class="anchor" href="#_aanmaken"></a>Aanmaken</h3>
<div class="paragraph">
<p>De functionaliteit voor gebruikersrollen is reeds aanwezig in het systeem. We kunnen zelf rollen defini√´ren en toewijzen. We opteren ter illustratie voor <em>Quoter</em> en <em>Admin</em>.</p>
</div>
<div class="listingblock">
<div class="title">Roles maken</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">insert into AspNetRoles (Id, Name, NormalizedName) values
(NEWID(), 'Admin', 'ADMIN'),
(NEWID(), 'Quoter', 'QUOTER')
go</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Roles toewijzen</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">insert into AspNetUserRoles (UserId, RoleId)
values
-- alice wordt quoter
(
    (select id from AspNetUsers where UserName = 'alice'),
    (select id from AspNetRoles where NormalizedName = 'QUOTER')
)
-- bob krijgt geen rechten (op dit moment)
go</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Roles Uitlezen</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">select u.Id, u.UserName, r.Name
from dbo.AspNetUserRoles ur
inner join dbo.AspNetUsers u on u.Id = ur.UserId
inner join dbo.AspNetRoles r on r.Id = ur.RoleId
go</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_doel"><a class="anchor" href="#_doel"></a>Doel</h3>
<div class="paragraph">
<p>We stellen als doel <code>GET pricequotes/{id}</code> toe te staan voor</p>
</div>
<div class="ulist">
<ul>
<li>
<p>backend <strong>systeem</strong> met claim <code>shipit.pricequote.api.read</code></p>
<div class="ulist">
<ul>
<li>
<p>geen user aanwezig</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>user</strong> met <code>Quoter</code> rol</p>
<div class="ulist">
<ul>
<li>
<p>via ui app met claim <code>shipit.pricequote.api.read</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In alle andere gevallen autoriseren we het request niet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user_profile_uitbreiden"><a class="anchor" href="#_user_profile_uitbreiden"></a>User Profile Uitbreiden</h3>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public static IEnumerable&lt;IdentityResource&gt; IdentityResources =&gt;
    new IdentityResource[]
    {
        new IdentityResources.OpenId(),
        new IdentityResources.Profile(),
        new IdentityResource( <i class="conum" data-value="1"></i><b>(1)</b>
            name: "roles",
            userClaims: new[] { JwtClaimTypes.Role }
        )
    };

//...

public static IEnumerable&lt;Client&gt; Clients =&gt;
    new Client[]
    {
        new Client {
            ClientId = "webapp-client",
            //...
            AllowedScopes = {
                IdentityServerConstants.StandardScopes.OpenId,
                IdentityServerConstants.StandardScopes.Profile,
                "shipit.pricequotes.api.read",
                "roles" <i class="conum" data-value="2"></i><b>(2)</b>
            },
            //...
        }
//...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Roles toevoegen want is geen standaard veld.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Via deze client mogen roles bevraagd worden.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Gezien het userprofile endpoint meer informatie moet meegeven dan standaard, overschrijven we de implementatie. Dit is een standaard template implementatie. Er is niets specifiek ShipIt aan het verhaal.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/ProfileService.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class ProfileService : IProfileService
{
    private readonly UserManager&lt;ApplicationUser&gt; _userManager;
    private readonly IUserClaimsPrincipalFactory&lt;ApplicationUser&gt; _claimsFactory;

    public ProfileService(UserManager&lt;ApplicationUser&gt; userManager,
                          IUserClaimsPrincipalFactory&lt;ApplicationUser&gt; claimsFactory)
    {
        _userManager = userManager;
        _claimsFactory = claimsFactory;
    }

    public async Task GetProfileDataAsync(ProfileDataRequestContext context)
    {
        var userId = context.Subject.GetSubjectId();
        var user = await _userManager.FindByIdAsync(userId);

        var principal = await _claimsFactory.CreateAsync(user);
        var claims = principal.Claims.ToList();

        <i class="conum" data-value="1"></i><b>(1)</b>
        var roles = await _userManager.GetRolesAsync(user);
        claims.AddRange(roles.Select(r =&gt; new Claim(JwtClaimTypes.Role, r)));

        <i class="conum" data-value="2"></i><b>(2)</b>
        claims = claims.Where(c =&gt; context.RequestedClaimTypes.Contains(c.Type)).ToList();
        context.IssuedClaims = claims;
    }

    public async Task IsActiveAsync(IsActiveContext context)
    {
        var userId = context.Subject.GetSubjectId();
        context.IsActive = await _userManager.FindByIdAsync(userId) is not null;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>AspNetUserRoles in de bestaande lijst van claims duwen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Alles uit de bestaande lijst wippen dat niet gevraagd werd. In principe vragen wij alles impliciet door de verschillende <code>identityresource</code> scopes mee te geven.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Remember, we geven die mee vanuit de UI!</p>
</div>
<div class="listingblock">
<div class="title">main.tsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const settings: UserManagerSettings = {
  // ...
  scope: "openid profile roles shipit.pricequotes.api.read"
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>We activeren de toegevoegde profile service in IS</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/HostingExtensions.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">//...
    ...
    .AddAspNetIdentity&lt;ApplicationUser&gt;()
    .AddProfileService&lt;ProfileService&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>
//...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hiet gebeurt het.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_afdwingen"><a class="anchor" href="#_afdwingen"></a>Afdwingen</h3>
<div class="paragraph">
<p>Voeg nuget <code>duende.identitymodel</code> toe aan <code>ShipIt.PriceQuote.Api</code>.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">//...
.AddJwtBearer(options =&gt;
{
    //...
    options.MapInboundClaims = false; <i class="conum" data-value="1"></i><b>(1)</b>
});
//...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Geen automapping van claims op properties met andere namen. We de draad niet verliezen.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We defini√´ren een eigen <em>AuthorizationRequirement</em> die de nodige info bevat om onze eigen Autorisatie logica te schrijven. Systemen met en zonder gebruikers moeten gebruik kunnen maken, dus we zullen een Claim of Role (combinatie) moeten evalueren.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/ClaimRoleRequirement.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class ClaimOrRoleRequirement : IAuthorizationRequirement
{
    public string Claim { get; }
    public string Role { get; }

    public ClaimOrRoleRequirement(string claim, string role)
    {
        Claim = claim;
        Role = role;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We schrijven de autorisatie redenering voor onze <code>ClaimOrRoleRequirement</code>. Deze is niet specifieke aan een bepaalde scope of rol. De logica is generiek.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/ShipItAuthHandler.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">using System;
using Duende.IdentityModel.Client;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authorization;

namespace ShipIt.PriceQuote.Api;

public class ShipItAuthHandler : AuthorizationHandler&lt;ClaimOrRoleRequirement&gt;
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public ShipItAuthHandler(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    protected override Task HandleRequirementAsync(
        AuthorizationHandlerContext context,
        ClaimOrRoleRequirement requirement)
    {
        var claims = context.User.Claims.ToList();

        // Als de app client de juiste _apiscope_ niet heeft...
        if (!claims.Exists(c =&gt; c.Value == requirement.Claim))
        {
            // ...is het NOT OK.
            context.Fail();
        }
        // Als de app client de juiste scope wel heeft...
        else
        {
            var userId = claims.FirstOrDefault(c =&gt; c.Type == "sub")?.Value;

            // ...en de call gebeurt door een _persoon_...
            if (userId is not null)
            {
                // ... dan vragen we meer info aan identity server...
                var client = new HttpClient();
                var disco = client
                    .GetDiscoveryDocumentAsync("https://localhost:5001").Result;

                var token = _httpContextAccessor
                    .HttpContext.GetTokenAsync("access_token").Result;

                var request = new UserInfoRequest
                {
                    Address = disco.UserInfoEndpoint,
                    Token = token,

                };

                var userInfo = client.GetUserInfoAsync(request).Result;

                // ... en de persoon heeft de juiste _rol_...
                if (userInfo.Claims.ToList()
                    .Exists(c =&gt; c.Type == "role" &amp;&amp; c.Value == requirement.Role))
                {
                    // ...dan is het OK.
                    context.Succeed(requirement);
                }
                // ... en de persoon heeft de juiste _rol_ niet
                else
                {
                    // ...dan is het NOT OK.
                    context.Fail();
                }
            }
            // ...en de call gebeurt door een _systeem_...
            else
            {
                // ...dan is het OK.
                context.Succeed(requirement);
            }
        }

        return Task.CompletedTask;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">builder.Services.AddAuthorizationBuilder()
    .AddPolicy("QuoteReadPolicy", policy =&gt;
        policy.Requirements.Add(
            new ClaimOrRoleRequirement( <i class="conum" data-value="1"></i><b>(1)</b>
                "shipit.pricequote.api.read",
                "Quoter")));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We gebruiken de nieuwe <code>ClaimOrRoleRequirement</code> en geven de concrete rol en scope mee die bij deze policy horen.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We zetten de <code>ShipItAuthHandler</code> klaar voor injectie. Deze gebruikt zelf <code>IHttpContextAccessor</code> dus die moet ook toegevoegd worden.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var builder = WebApplication.CreateBuilder(args);
builder.Services.AddHttpContextAccessor();
builder.Services.AddSingleton&lt;IAuthorizationHandler, ShipItAuthHandler&gt;();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testen"><a class="anchor" href="#_testen"></a>Testen</h3>
<div class="paragraph">
<p>Wanneer je via de UI test, zal Alice (200 OK) een quote kunnen lezen en Bob (403 Forbidden) niet.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_scoping"><a class="anchor" href="#_data_scoping"></a>Data Scoping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bepaalde autorisatielogica kan je niet kwijt in generieke concepten als scopes en rollen. Wat als gebruiker <code>g</code> ‚úÖ via systeem <code>s</code> ‚úÖ actie <code>a</code> ‚úÖ mag uitvoeren&#8230;&#8203; maar enkel op een deel <code>d</code> ‚ùå van de data (<em>Data Scoping</em>)? Daar hebben we nog geen oplossing voor!</p>
</div>
<div class="sect2">
<h3 id="_ownership"><a class="anchor" href="#_ownership"></a>Ownership</h3>
<div class="paragraph">
<p>Vaak willen we kunnen benoemen wie de eigenaar van een record, of document, is. Dit kunnen we eenvoudigweg doen door het UserId op te slaan bij de informatie. Typisch in een veld genaamd <code>CreatedByUserId</code> of <code>OwnerUserId</code>.</p>
</div>
<div class="paragraph">
<p>In een ApiController kan je de <code>sub</code> claim uitlezen en laten afdalen in de call chain.</p>
</div>
<div class="listingblock">
<div class="title">Voorbeeld</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">[HttpPost]
[Authorize(Policy = "QuoteWritePolicy")]
public async ... CreatePriceQuoteAsync(...)
{
    var userId = User.FindFirst("sub")?.Value; <i class="conum" data-value="1"></i><b>(1)</b>

    var result = await priceQuoteService
        .CreatePriceQuoteAsync(
            priceQuoteRequestContract,
            userId);<i class="conum" data-value="2"></i><b>(2)</b>

    return CreatedAtAction(...);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Wanneer de api call komt van een systeem dat door een user gebruikt wordt, zal het <code>userId</code> ingevuld zijn.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Je kan dit meegeven aan de service layer en logica rond bouwen.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Wanneer iemand nu quotes komt lezen, kan je beslissen Forbidden terug te geven indien deze aan een andere user toebehoort. Je kan bijvoorbeld ook beslissen  een systeem dat niet in naam van user callt, de data wel mag zien.</p>
</div>
</div>
<div class="sect2">
<h3 id="_role_based"><a class="anchor" href="#_role_based"></a>Role Based</h3>
<div class="paragraph">
<p>We kunnen voorgaand voorbeeld uitbreiden. Stel:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Je mag alleen je eigen quotes lezen</p>
</li>
<li>
<p>Tenzij de call komt van een systeem zonder menselijke user</p>
</li>
<li>
<p>&#8230;&#8203; Of de menselijke user de Admin rol heeft, dan mag het ook</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_associatie"><a class="anchor" href="#_associatie"></a>Associatie</h3>
<div class="paragraph">
<p>Soms wil je ook data scopen door associatie. Een praktisch voorbeeld is het Chamilo systeem van de school. Je kan gepubliceerde documentjes in een vak zien</p>
</div>
<div class="ulist">
<ul>
<li>
<p>niet omdat ze door jou gemaakt zijn</p>
</li>
<li>
<p>niet omdat je een admin bent</p>
</li>
<li>
<p>&#8230;&#8203; maar wel omdat jouw user geassocieerd is aan het vak waarin de documentjes staan.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <p>This page was built using a customized version of the Antora default UI. The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Course material may *not* be used to teach, tutor, coach, or present without obtaining explicit consent from Stefan Courteaux.</p>
</footer><script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
