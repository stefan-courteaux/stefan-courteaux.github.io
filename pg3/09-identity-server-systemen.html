<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>App Clients (OAuth) :: Programmeren Gevorderd 3 (BETA)</title>
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Programmeren Gevorderd 3 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pg3" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Gevorderd 3</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="01-cloud-connected.html">Cloud Connected</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-microservices.html">Microservices</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-az-devops.html">Azure DevOps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-git.html">Git Gebruik</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-cosmos.html">Cosmos Database</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-blob.html">Blob Storage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-middleware.html">Middleware</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-open-data-docker.html">Open Data &amp; Docker ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-02-secret-management.html">Secret Management ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-pipelines.html">DevOps PipelinesÔ∏è ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-auth-2526.html">Authenticatie ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-auth-2526-2.html">Autorisatie ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-afronden2526.html">Afronden ‚≠êÔ∏è</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-tips.html">Tips</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-auth.html">Authenticatie AJ2425 üôÖ‚Äç‚ôÇÔ∏è</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="09-identity-server-systemen.html">App Clients (OAuth)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-identity-server-gebruikers.html">Test Users (OIDC)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-identity-server-shipitapp.html">Web App Verbinden</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-identity-server-sql.html">Config in Azure SQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-identity-server-aspnetid.html">ASP.Net Identity Users</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="09-identity-sql-server-docker.html">SQL Server Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-afronden.html">Totaalplaatje Afronden</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="80-lesopnames-2425S2.html">Lesopnames üì∫</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gevorderd 3</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Gevorderd 3</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gevorderd 3</a></li>
    <li><a href="09-auth.html">Authenticatie AJ2425 üôÖ‚Äç‚ôÇÔ∏è</a></li>
    <li><a href="09-identity-server-systemen.html">App Clients (OAuth)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">App Clients (OAuth)</h1>
<div class="sect1">
<h2 id="_doel_van_deze_les"><a class="anchor" href="#_doel_van_deze_les"></a>Doel van deze les</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Identity Server opzetten</p>
</li>
<li>
<p>OAuth (met Identity Server)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identity_server_opzetten"><a class="anchor" href="#_identity_server_opzetten"></a>Identity Server Opzetten</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Identity Server is intussen vlot op te zetten via een dotnet template. Deze template kan gebruikt worden om het project aan te maken. Dit project bevat de basics om een Identity service te starten en laadt de nodige dependencies.</p>
</div>
<div class="literalblock">
<div class="title">Templates Installeren</div>
<div class="content">
<pre>dotnet new install Duende.IdentityServer.Templates</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>The following template packages will be installed:
   Duende.IdentityServer.Templates

Success: Duende.IdentityServer.Templates::7.0.4 installed the following templates:
Template Name                                               Short Name     Language
----------------------------------------------------------  -------------  --------
Duende BFF Host using a Remote API                          bff-remoteapi  [C#]
Duende BFF using a Local API                                bff-localapi   [C#]
Duende IdentityServer Empty                                 isempty        [C#]
Duende IdentityServer Quickstart UI (UI assets only)        isui           [C#]
Duende IdentityServer with ASP.NET Core Identity            isaspid        [C#]
Duende IdentityServer with Entity Framework Stores          isef           [C#]
Duende IdentityServer with In-Memory Stores and Test Users  isinmem        [C#]</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/templates.png" alt="templates">
</div>
</div>
<div class="paragraph">
<p>Nu kan je via de UI van Visual Studio een "leeg" IdentityServer project toevoegen aan onze solution.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/project.png" alt="project">
</div>
</div>
<div class="paragraph">
<p>Wanneer we onze Identity Server starten, kunnen we het openid-configuration endpoint bezoeken.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>https://localhost:5001/.well-known/openid-configuration</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/disco.png" alt="disco">
</div>
</div>
<div class="paragraph">
<p>Dit endpoint publiceert een <em>Discovery Document</em>. Het document bevat een gestructureerd (json) overzicht van de endpoints en andere configuratie gerelateerd aan onze Identity Server. Client systemen hebben (een deel van) deze informatie nodig om door de Auth flows te lopen.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
    "issuer":"https://localhost:5001",
    "jwks_uri":"https://localhost:5001/.well-known/openid-configuration/jwks",
    "authorization_endpoint":"https://localhost:5001/connect/authorize",
    "token_endpoint":"https://localhost:5001/connect/token",
    "userinfo_endpoint":"https://localhost:5001/connect/userinfo",
    "end_session_endpoint":"https://localhost:5001/connect/endsession"
    ...
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oauth_applicatie_clients"><a class="anchor" href="#_oauth_applicatie_clients"></a>OAuth Applicatie Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>De eerste component die we gaan beveiligen is de Quote api. Deze zal enkel nog calls mogen accepteren van geauthenticeerde systemen.</p>
</div>
<div class="sect2">
<h3 id="_identity_server_configureren"><a class="anchor" href="#_identity_server_configureren"></a>Identity Server Configureren</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In een productiecontext zal Identity Server een databank nodig hebben om api configuratie en credentials in op te slaan, zeker wanneer men met user accounts werkt. Daar komen we later op terug. We kunnen de nodige configuratie en applicatieclients voorlopig hardcoden op de daarvoor voorziene plaats.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We testen ons systeem via Postman. <strong>We maken een passende <em>client</em> in Identity Server</strong>. Deze <em>client</em> wordt specifiek <strong>voor onze Postman tests</strong> gebruikt. Een ander systeem zal zijn eigen client krijgen, eventueel met andere rechten.</p>
</div>
<div class="paragraph">
<p><strong>We maken een <em>scope</em> aan.</strong> We kiezen de naam, en later de betekenis ervan in onze code, volledig zelf. Een scope zal zich vertalen naar een bepaalde operatie (of operaties) in het systeem. Op het moment dat de gekozen operaties uitgevoerd worden, zal het systeem bekijken of de caller wel over de juiste, door ons gekozen, scope beschikt. We starten met √©√©n globale scope <strong>voor de Quote Api</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">public static class Config
{
    public static IEnumerable&lt;IdentityResource&gt; IdentityResources =&gt;
        new IdentityResource[]
        {
            new IdentityResources.OpenId()
        };

    public static IEnumerable&lt;ApiScope&gt; ApiScopes =&gt; new ApiScope[]
    {
        new ApiScope(
            name: "shipit.pricequotes.api",
            displayName: "ShipIt PricesQuotes Api Acccess")
    };

    public static IEnumerable&lt;Client&gt; Clients =&gt;new Client[]
    {
        new Client{
            ClientId = "postman-client", <i class="conum" data-value="1"></i><b>(1)</b>
            AllowedGrantTypes = GrantTypes.ClientCredentials, <i class="conum" data-value="2"></i><b>(2)</b>
            ClientSecrets = { new Secret("eenGrootGeheim".Sha256())}, <i class="conum" data-value="3"></i><b>(3)</b>
            AllowedScopes = { "shipit.pricequotes.api" } <i class="conum" data-value="4"></i><b>(4)</b>
        }
    };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Kan een willekeurige string zijn. Gebruik een sprekende naam wanneer mogelijk.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Client is bedoeld om in een <a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow/client-credentials-flow">Client Credentials Flow</a> gebruikt te worden.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In Identity Server houden we een hash bij van het secret. De cleartext versie wordt overhandigd aan de klant. Wij bewaren de cleartext versie niet. Moest Identity Server op dit moment al met een databank gekoppeld zijn, zouden we daarin het resultaat van de hash bewaren.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Scopes waar deze Client gebruik kan van maken.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Config.cs</code> wordt ingelezen door <code>ConfigureServices()</code> in <code>HostingExtensions.cs</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_api_beveiligen_postman_test"><a class="anchor" href="#_api_beveiligen_postman_test"></a>Api Beveiligen &amp; PostMan Test</h3>
<div class="paragraph">
<p>Nu we een Identity Server met configuratie hebben, kunnen we de Quote api effectief gaan beveiligen</p>
</div>
<div class="paragraph">
<p>We voegen nuget package <code>Microsoft.AspNetCore.Authentication.JwtBearer</code> versie <code>8.0.11</code> toe aan <code>ShipIt.PriceQuotes.Api</code>.</p>
</div>
<div class="paragraph">
<p>Dit laat ons toe de authenticatie en autorisatie tijdens het bootstrappen van de App in te stellen.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuotes.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">//...
builder.Services.AddAuthentication()
    .AddJwtBearer(options =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
    {
        options.Authority = "https://localhost:5001"; <i class="conum" data-value="2"></i><b>(2)</b>
        options.TokenValidationParameters.ValidateAudience = false; <i class="conum" data-value="3"></i><b>(3)</b>
    });
builder.Services.AddAuthorization(); <i class="conum" data-value="4"></i><b>(4)</b>
//...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JwtBearer is het soort authenticatie token.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Onze service zal deze Identity Provider vertrouwen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Optionele audience claim check. Out of scope voor de lessen.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Web api endpoints kunnen nu inhaken op autorisatie.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Om af te dwingen dat een caller een token nodig heeft om een operatie in onze Quote controller aan te roepen, gebruiken we het <code>Authorize</code> attribute.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuotes.Api/Controllers/PriceQuotesController.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">[Route("api/[controller]")]
[Authorize] <i class="conum" data-value="1"></i><b>(1)</b>
[ApiController]
public class QuoteController : ControllerBase
{
    //...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Elke actie in deze Controller vereist nu een geauthenticeerde caller.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start Identity Server √©n de Quote Api op. Doe een <code>POST</code> request. Dit resulteert nu in <code>HTTP 401</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/401.png" alt="401">
</div>
</div>
<div class="paragraph">
<p>We moeten een token ophalen bij Identity Server. Hiervoor maken we gebruik van de <em>Client Credentials</em> die we eerder geconfigureerd hebben.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>curl --location 'https://localhost:5001/connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'client_id=postman-client' \
--data-urlencode 'client_secret=eenGrootGeheim'</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/200-1.png" alt="200 1">
</div>
</div>
<div class="paragraph">
<p>We kunnen de inhoud van een token analyseren op <a href="https://jwt.io">jwt.io</a>. Handig.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/jwt.png" alt="jwt">
</div>
</div>
<div class="paragraph">
<p>Wanneer we nu in de api call naar de Quote Api de <code>Authorization</code> header zetten met daarin het token, zal de call wel werken. Het formaat van header waarde is "Bearer", gevolgd door een spatie, gevolgd door de inhoud van het token.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>curl --location 'https://localhost:7136/api/pricequotes' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IkM0NEY5QkQ2MzBDM0FEQUNDNThCMzNDMTVGMDZGNjFGIiwidHlwIjoiYXQrand0In0.eyJpc3MiOiJodHRwczovL2xvY2FsaG9zdDo1MDAxIiwibmJmIjoxNzMzMjM0NzA3LCJpYXQiOjE3MzMyMzQ3MDcsImV4cCI6MTczMzIzODMwNywiYXVkIjoiaHR0cHM6Ly9sb2NhbGhvc3Q6NTAwMS9yZXNvdXJjZXMiLCJzY29wZSI6WyJzaGlwaXQucHJpY2VxdW90ZXMuYXBpIl0sImNsaWVudF9pZCI6InBvc3RtYW4tY2xpZW50IiwianRpIjoiRjgyNUExMDMwQTdDNEU0NTA5NDAxNzk0N0E5QTIyRUMifQ.dHW3vRZvNtZClg-L4K0XiAsR6-NliVJjaPKJQVCRbbm20n8OB0CSkW6-5pfpLq-wfzzGuuxuf_lR96aWHZx_JT3NQ_LP2UKjQ65an1r7CxHRxf7CF6gdw1SqTSlHzn-zMoJo2WmZiTzbmzPywUg8qPPSPiKiJpcBBh54O5q83UXBgOX-4hRzA6kkwOyMZzqHRjTixHFdh0ouEN_PWVkT3gBNkLmf0Zm6ngTRX1yVZiip2Q589Ms8vzfAVpLfDTYf_234fI0O7gEqIQRIOBKltIVmzeQqIjUjj36TDz5XvPOlwDrxMEcDi0hYVbh7Fb0TmR7q9RrUfMcSUPn-_L1CpQ' \
--data '{
    "LengthCm" : 33,
    "WidthCm" : 40,
    "HeightCm" : 99,
    "WeightKg": 10,
    "CountryFrom": "LU",
    "CountryTo": "FR"
}'</pre>
</div>
</div>
<div class="paragraph">
<p>In Postman kan je gebruik maken van de functionaliteit in de "Authorization" tab, maar dat is niet noodzakelijk. In de achtergrond is en blijft het gewoon een header.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/200-2.png" alt="200 2">
</div>
</div>
<div class="paragraph">
<p>Hoe kan dit veilig zijn als we de inhoud van het token gewoon kunnen bekijken via een tool zoals jwt.io?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>De quote api spreekt met Identity Server en kan navragen of het token daar uitgereikt werd.</p>
</li>
<li>
<p>Het token heeft een vervaldatum. Wanneer een token lekt, blijft het dus niet lang bruikbaar.</p>
</li>
<li>
<p>Je hebt de <code>client_id</code> √©n <code>client_secret</code> nodig om een nieuw token aan te vragen.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_client_api_authenticeren"><a class="anchor" href="#_client_api_authenticeren"></a>Client Api Authenticeren</h3>
<div class="paragraph">
<p>Wanneer we nu ook de Label service starten en deze aanroepen, zullen we ondervinden dat deze de Quote api niet met succes kan aanroepen. Dit is te verwachten gezien de Quote api Auth afdwingt, maar we in de Label api nog niets aangepast hebben.</p>
</div>
<div class="paragraph">
<p>We voegen in Identity Server een Client toe voor de Label api.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">//...
    new Client{
        ClientId = "label-api",
        AllowedGrantTypes = GrantTypes.ClientCredentials,
        ClientSecrets = { new Secret("eenGroterGeheim".Sha256())},
        AllowedScopes = { "shipit.pricequotes.api" }
    }
//...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nu gaan we in de label api een token moeten ophalen voor we de call naar de quote api met succes maken.</p>
</div>
<div class="paragraph">
<p>Voeg nuget package <code>Duende.IdentityModel</code> toe aan de Label Api.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.Labels.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">app.MapPost("api/labels", ...) =&gt; {

    var httpClient = clientFactory.CreateClient();

    // Authenticate before fetching price
    var disco = await httpClient.GetDiscoveryDocumentAsync("https://localhost:5001");<i class="conum" data-value="1"></i><b>(1)</b>
    var tokenResponse = await httpClient.RequestClientCredentialsTokenAsync(<i class="conum" data-value="2"></i><b>(2)</b>
        new ClientCredentialsTokenRequest {
            Address = disco.TokenEndpoint,
            ClientId = "label-api",
            ClientSecret = "eenGroterGeheim",
            Scope = "shipit.pricequotes.api"
        });

    // Fetch Price
    httpClient.SetBearerToken(tokenResponse.AccessToken!);<i class="conum" data-value="3"></i><b>(3)</b>
    var quoteResponse = await httpClient.GetFromJsonAsync&lt;PriceQuoteResponseContract&gt;($"{options.Value.QuoteApiBaseUrl}{contract.QuoteId}");

    // Drop auth before next request
    httpClient.SetBearerToken(string.Empty);<i class="conum" data-value="4"></i><b>(4)</b>

    // Validate Address (if FR)
    if(contract.RecipientCountry == "FR")
    {
        //...
    }

    //...

    return TypedResults.CreatedAtRoute(trackingNumber, "GetLabel", new { trackingnumber = trackingNumber});
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inlezen van het informatiedocument dat Identity Server publiceert om token endpoint te kennen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ophalen van een token. In een professionele setting zullen deze waarden uit configuratie komen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Plaatsen van het AccessToken op de httpClient. Elke request met deze client zal nu het token dragen.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Stuur het token niet naar api&#8217;s waar het niet voor dient.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nu zal de Postman call naar de Label api wel slagen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/label-auth.png" alt="label auth">
</div>
</div>
<div class="paragraph">
<p>Intussen is de sequentie van operaties indrukwekkend geworden. 3 ShipIt Api Services, 2 Azure Database Services en 1 externe Open Data Api!</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Postman &#8594; Label Api (geen auth!)</p>
<div class="ulist">
<ul>
<li>
<p>Label Api &#8594; Token Vragen Aan Identity Server</p>
</li>
<li>
<p>Label Api &#8594; Quote Api (auth!)</p>
<div class="ulist">
<ul>
<li>
<p>Quote Api &#8594; Token Valideren Bij Identity Server</p>
</li>
<li>
<p>Quote Api &#8594; Azure Cosmos DB</p>
</li>
<li>
<p>Quote Api &#8592; Azure Cosmos DB</p>
</li>
</ul>
</div>
</li>
<li>
<p>Label Api &#8592; Quote Api</p>
</li>
<li>
<p>Label Api &#8594; FR Adres Api (geen auth!)</p>
</li>
<li>
<p>Label Api &#8592; FR Adres Api</p>
</li>
<li>
<p>Label Api &#8594; Label Domein</p>
<div class="ulist">
<ul>
<li>
<p>Label Domein &#8594; Azure Blob Storage</p>
</li>
<li>
<p>Label Domein &#8594; Azure Blob Storage</p>
</li>
</ul>
</div>
</li>
<li>
<p>Label Api &#8592; Label Domein</p>
</li>
</ul>
</div>
</li>
<li>
<p>Postman &#8592; Label Api</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_autorisatie_concretiseren"><a class="anchor" href="#_autorisatie_concretiseren"></a>Autorisatie Concretiseren</h3>
<div class="paragraph">
<p>Op dit moment valideert de Quote api enkel of de caller een token heeft. Er worden geen "scopes" gecontroleerd. Dit wil zeggen dat elke client alle endpoints van de service mag aanroepen. Dat willen we niet.</p>
</div>
<div class="paragraph">
<p>We willen controle krijgen over welke client welke endpoints mag aanroepen. We gaan nieuwe scopes kiezen, bijvoorbeeld 1 per endpoint, en deze registeren in Identity Server.</p>
</div>
<div class="paragraph">
<p>Dus in plaats van <code>shipit.pricequotes.api</code> toe te kennen als enige scope aan de twee clients, zullen we de functionaliteit splitsen.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.IdentityServer/Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">public static class Config
{
    //...
    public static IEnumerable&lt;ApiScope&gt; ApiScopes =&gt; new ApiScope[]
    {
        new ApiScope(
            name: "shipit.pricequotes.api.read", <i class="conum" data-value="1"></i><b>(1)</b>
            displayName: "ShipIt PricesQuotes Api Read Access"),
        new ApiScope(
            name: "shipit.pricequotes.api.write", <i class="conum" data-value="2"></i><b>(2)</b>
            displayName: "ShipIt PricesQuotes Api Write Access")
    };

    public static IEnumerable&lt;Client&gt; Clients =&gt;new Client[]
    {
        new Client{
            ClientId = "postman-client",
            AllowedGrantTypes = GrantTypes.ClientCredentials,
            ClientSecrets = { new Secret("eenGrootGeheim".Sha256())},
            AllowedScopes = { <i class="conum" data-value="3"></i><b>(3)</b>
                "shipit.pricequotes.api.read",
                "shipit.pricequotes.api.write" }
        },
        new Client{
            ClientId = "label-api",
            AllowedGrantTypes = GrantTypes.ClientCredentials,
            ClientSecrets = { new Secret("eenGroterGeheim".Sha256())},
            AllowedScopes = { "shipit.pricequotes.api.read" } <i class="conum" data-value="4"></i><b>(4)</b>
        }
    };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Een scope om te lezen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Een scope om te schrijven.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Onze test client voor postman moet alles kunnen.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>De label client hoeft alleen quotes op te halen, niet te maken. We geven niet meer rechten dan strikt noodzakelijk.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Bij het opvragen van een token gaan we nu de scopes meegeven die we willen gebruiken. Meerdere scopes worden gescheiden door een spatie. Identity Server zal een token geven voor die scopes <strong>als</strong> de configuratie bevestigt dat de client daar de rechten toe heeft. Als we geen scopes vermelden in de token aanvraag, krijgen we by default alle scopes waar we recht op hebben.</p>
</div>
<div class="paragraph">
<p>We moeten er ook voor zorgen dat de quote api deze granulaire vereiste afcheckt.</p>
</div>
<div class="paragraph">
<p>De oneliner in <code>ShipIt.PriceQuotes.Api/Program.cs</code> wordt vervangen door een rijkere definitie.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>builder.Services.AddAuthorization();</pre>
</div>
</div>
<div class="listingblock">
<div class="title">ShipIt.Quote.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">//...
builder.Services.AddAuthorizationBuilder()
    .AddPolicy("QuoteReadPolicy", policy =&gt;
        {
            policy.RequireAuthenticatedUser();
            policy.RequireClaim("scope", "shipit.pricequotes.api.read");
        })
    .AddPolicy("QuoteWritePolicy", policy =&gt;
        {
            policy.RequireAuthenticatedUser();
            policy.RequireClaim("scope", "shipit.pricequotes.api.write");
        });
//...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We laken gebruik van deze policies op de controller acties.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.PriceQuotes.Api/Controllers/PriceQuotesController.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">[ApiController]
[Route("api/[controller]")]
[Authorize]
public class PriceQuotesController : ControllerBase
{
    //...

    [HttpPost]
    [Authorize(Policy = "QuoteWritePolicy")]
    //...
    public async Task&lt;ActionResult&lt;PriceQuoteResponseContract&gt;&gt; CreateQuoteAsync()
    //...

    [HttpGet]
    [Authorize(Policy = "QuoteReadPolicy")]
    //...
    public async Task&lt;ActionResult&lt;PriceQuoteResponseContract&gt;&gt; GetQuoteAsync()
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We controleren de goede werking van onze configuratie met Postman. Drie scenario&#8217;s voor de <code>GET</code> operatie bieden al heel wat inzicht.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>met token dat enkel read scope heeft &#8658; ok</p>
</li>
<li>
<p>met token dat enkel write scope heeft &#8658; nok</p>
</li>
<li>
<p>met token dat read en write scopes heeft &#8658; ok</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Eenmaal de Postman testen bevestigen dat alles rond de Quote api naar behoren werkt, kunnen we nu ook de Label api aanpassen om de juiste scope te gebruiken.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.Labels.Api/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">// Authenticate before fetching price
var disco = await httpClient.GetDiscoveryDocumentAsync("https://localhost:5001");
var tokenResponse = await httpClient.RequestClientCredentialsTokenAsync(
    new ClientCredentialsTokenRequest {
        Address = disco.TokenEndpoint,
        ClientId = "label-api",
        ClientSecret = "eenGroterGeheim",
        Scope = "shipit.pricequotes.api.read" <i class="conum" data-value="1"></i><b>(1)</b>
    });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>De gepaste <code>read</code> scope. De label api kan nu enkel quotes lezen, en niet maken. Dit ligt in lijn met het ontwerp van de applicatie.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De Label api zal nu ook terug werken wanneer we deze vanuit Postman aanroepen.</p>
</div>
<div class="openblock">
<div class="content">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
De label api authenticeert zich tov de Quote api, maar dwingt zelf (nog) geen security af richting zijn eigen callers!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment"><a class="anchor" href="#_deployment"></a>Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We kunnen de Identity Server deployen naar Azure zoals gewoonlijk, het is ook <em>gewoon</em> een web api.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>az webapp up `
--name pg3-shipit-stefanc-identity-api `
--plan pg3-shipit-stefanc-plan `
--resource-group pg3-shipit-stefanc `
--location westeurope `
--os-type Linux

{
  "URL": "http://pg3-shipit-stefanc-identity-api.azurewebsites.net", <i class="conum" data-value="1"></i><b>(1)</b>
  "appserviceplan": "pg3-shipit-stefanc-plan",
  "location": "westeurope",
  "name": "pg3-shipit-stefanc-identity-api",
  "os": "Linux",
  "resourcegroup": "pg3-shipit-stefanc",
  ...
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We gaan dit in de configuratie van de andere services moeten opnemen.</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>az webapp up `
--name pg3-shipit-stefanc-quote-api `
--plan pg3-shipit-stefanc-plan `
--resource-group pg3-shipit-stefanc `
--location westeurope `
--os-type Linux</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>az webapp up `
  --name pg3-shipit-stefanc-label-api `
  --plan pg3-shipit-stefanc-plan `
  --resource-group pg3-shipit-stefanc `
  --location westeurope `
  --os-type linux</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server/azure-secured.png" alt="azure secured">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authority_testen"><a class="anchor" href="#_authority_testen"></a>Authority Testen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Laat de lokale Quote api verwijzen naar de Identity Server op Azure.</p>
</div>
<div class="paragraph">
<p>Vraag een token aan de lokale Identity Server.</p>
</div>
<div class="paragraph">
<p>Doe een call naar de lokale Quote api met het lokaal verkregen token.</p>
</div>
<div class="paragraph">
<p>Dit geeft een exception.</p>
</div>
<div class="paragraph">
<p>De quote service zal de tokens van onze lokale identity service niet langer accepteren. We moeten een token halen bij de Identity Server op Azure want dat is de provider die nu vertrouwd wordt.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oefening"><a class="anchor" href="#_oefening"></a>Oefening</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Probeer zelf de taak van de week te implementeren. Je kan steeds kijken naar de code uit de les als je vast loopt.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_referenties"><a class="anchor" href="#_referenties"></a>Referenties</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://jwt.io">jwt.io</a></p>
</li>
<li>
<p><a href="https://duendesoftware.com/products/identityserver">Identity Server</a></p>
</li>
<li>
<p><a href="https://www.microsoft.com/en-us/security/business/security-101/what-is-oauth">OAuth@Microsoft</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <p>This page was built using a customized version of the Antora default UI. The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Course material may *not* be used to teach, tutor, coach, or present without obtaining explicit consent from Stefan Courteaux.</p>
</footer><script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
